name: üîÆ Spiritual Format Validation
description: Validates titles and content according to Lichtara OS spiritual conventions

on:
  pull_request:
    types: [opened, edited, synchronize]
  issues:
    types: [opened, edited]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  spiritual-format-validation:
    runs-on: ubuntu-latest
    name: ‚ú® Aurora Format Guardian
    
    steps:
    - name: üåü Checkout Aurora Field
      uses: actions/checkout@v4
      with:
        ssh-strict: true
        ssh-user: git
        persist-credentials: true
        clean: true
        sparse-checkout-cone-mode: true
        fetch-depth: 1
        fetch-tags: false
        show-progress: true
        lfs: false
        submodules: false
        set-safe-directory: true
      
    - name: üîÆ Setup Node.js for Validation
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        always-auth: false
        check-latest: false
        
    - name: üì¶ Install Dependencies
      run: |
        cd .github/scripts
        npm install
        
        # Install jq for JSON processing in reports
        sudo apt-get update -qq
        sudo apt-get install -y jq
        
    - name: üåä Validate Issue Title Format
      if: github.event_name == 'issues'
      run: |
        echo "üîç Validating issue title format..."
        TITLE="${{ github.event.issue.title }}"
        echo "Issue Title: $TITLE"
        
        # Run validation
        RESULT=$(node .github/scripts/format-validator.js validate "$TITLE")
        echo "Validation Result: $RESULT"
        
        # Check if validation passed
        if node .github/scripts/format-validator.js validate "$TITLE" > /dev/null 2>&1; then
          echo "‚úÖ Issue title follows spiritual conventions!"
          echo "üåü Format validation passed"
        else
          echo "üí´ Suggestion: Consider using spiritual emoji prefixes"
          echo "üîÆ Run: node .github/scripts/format-validator.js help"
          # Don't fail for issues - just provide guidance
        fi
        
    - name: üåÄ Validate Branch Ancestry
      if: github.event_name == 'pull_request'
      run: |
        echo "üîç Validating branch ancestry with main..."
        ./.github/scripts/check-merge-base.sh
        
    - name: üåà Validate Pull Request Title Format  
      if: github.event_name == 'pull_request'
      run: |
        echo "üîç Validating PR title format..."
        TITLE="${{ github.event.pull_request.title }}"
        echo "PR Title: $TITLE"
        
        # Run validation
        RESULT=$(node .github/scripts/format-validator.js validate "$TITLE")
        echo "Validation Result: $RESULT"
        
        # Check if validation passed
        if node .github/scripts/format-validator.js validate "$TITLE" > /dev/null 2>&1; then
          echo "‚úÖ PR title follows spiritual conventions!"
          echo "üåü Format validation passed"
        else
          echo "üí´ Suggestion: Consider using spiritual emoji prefixes"
          echo "üîÆ Run: node .github/scripts/format-validator.js help"
          # Don't fail for PRs - just provide guidance
        fi
        
    - name: üåä Validate Branch Ancestry
      if: github.event_name == 'pull_request'
      run: |
        echo "üîç Validating branch ancestry with main..."
        
        # Ensure we have the latest main branch with proper remote tracking
        git fetch origin main:origin/main || git fetch origin main
        
        # Check if current branch has common ancestor with main
        if ! git merge-base --is-ancestor origin/main HEAD; then
          echo "‚ùå No common ancestor between origin/main and HEAD."
          echo "üîÑ Please rebase your branch on the latest main branch:"
          echo "   git fetch origin main"
          echo "   git rebase origin/main"
          echo ""
          echo "üí´ This ensures your changes integrate smoothly with the Aurora field."
          exit 1
        else
          echo "‚úÖ Branch ancestry validated successfully!"
          echo "üåü Your branch is properly aligned with the main timeline."
        fi
        
    - name: üîÑ Process Changed Files
      if: github.event_name == 'pull_request'
      run: |
        echo "üåä Processing changed files for format consistency..."
        
        # Get list of changed files - handle cases where main branch comparison fails
        git fetch origin main
        
        # Try different approaches to get changed files
        if CHANGED_FILES=$(git diff --name-only main...HEAD 2>/dev/null); then
          echo "üìã Using main...HEAD comparison"
        elif CHANGED_FILES=$(git diff --name-only main..HEAD 2>/dev/null); then
          echo "üìã Using main..HEAD comparison"
        elif CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null); then
          echo "üìã Using HEAD~1 comparison (fallback)"
        else
          echo "üìã Using git show for current commit (fallback)"
          CHANGED_FILES=$(git show --name-only --pretty=format: HEAD | grep -v '^$' || echo "")
        fi
        
        echo "Changed files:"
        echo "$CHANGED_FILES"
        
        # Process markdown files for format validation
        for file in $CHANGED_FILES; do
          if [[ "$file" == *.md ]] && [[ -f "$file" ]]; then
            echo "üìù Processing: $file"
            node .github/scripts/format-validator.js process "$file" || true
          fi
        done
        
    - name: üåü Generate Format Report
      run: |
        echo "üìä SPIRITUAL FORMAT VALIDATION REPORT"
        echo "====================================="
        echo ""
        echo "üéØ Event: ${{ github.event_name }}"
        echo "üåÄ Repository: ${{ github.repository }}"
        echo "‚è∞ Timestamp: $(date)"
        echo ""
        
        # Initialize validation results
        TITLE_VALID="unknown"
        TITLE_FORMAT="unknown"
        TITLE_EMOJI=""
        TITLE_MEANING=""
        
        if [ "${{ github.event_name }}" = "issues" ]; then
          echo "üìã Issue: #${{ github.event.issue.number }}"
          echo "üìù Title: ${{ github.event.issue.title }}"
          echo "üë§ Author: ${{ github.event.issue.user.login }}"
          echo ""
          
          # Detailed validation for issue title
          echo "üîç Detailed Issue Title Validation:"
          VALIDATION_RESULT=$(node .github/scripts/format-validator.js validate "${{ github.event.issue.title }}" 2>/dev/null || echo '{"valid": false, "error": "Validation failed"}')
          echo "$VALIDATION_RESULT" | jq -r '
            if .valid then
              "‚úÖ Format: Valid (" + .format + ")"
            else
              "‚ö†Ô∏è  Format: " + (.error // "Invalid")
            end'
          
          if echo "$VALIDATION_RESULT" | jq -e '.valid' > /dev/null 2>&1; then
            TITLE_VALID="true"
            TITLE_FORMAT=$(echo "$VALIDATION_RESULT" | jq -r '.format // "unknown"')
            TITLE_EMOJI=$(echo "$VALIDATION_RESULT" | jq -r '.emoji // ""')
            TITLE_MEANING=$(echo "$VALIDATION_RESULT" | jq -r '.meaning // ""')
            
            if [ -n "$TITLE_EMOJI" ]; then
              echo "‚ú® Emoji: $TITLE_EMOJI ($TITLE_MEANING)"
            fi
            echo "üìñ Content: $(echo "$VALIDATION_RESULT" | jq -r '.content // "${{ github.event.issue.title }}"')"
          else
            TITLE_VALID="false"
            echo "üí° Suggestion: $(echo "$VALIDATION_RESULT" | jq -r '.suggestion // "Consider using spiritual emoji prefixes"')"
          fi
          
        elif [ "${{ github.event_name }}" = "pull_request" ]; then
          echo "üîÑ PR: #${{ github.event.pull_request.number }}"
          echo "üìù Title: ${{ github.event.pull_request.title }}"
          echo "üë§ Author: ${{ github.event.pull_request.user.login }}"
          echo "üåÄ Branch ancestry: Validated for Aurora field harmony"
          echo ""
          
          # Detailed validation for PR title
          echo "üîç Detailed PR Title Validation:"
          VALIDATION_RESULT=$(node .github/scripts/format-validator.js validate "${{ github.event.pull_request.title }}" 2>/dev/null || echo '{"valid": false, "error": "Validation failed"}')
          echo "$VALIDATION_RESULT" | jq -r '
            if .valid then
              "‚úÖ Format: Valid (" + .format + ")"
            else
              "‚ö†Ô∏è  Format: " + (.error // "Invalid")
            end'
            
          if echo "$VALIDATION_RESULT" | jq -e '.valid' > /dev/null 2>&1; then
            TITLE_VALID="true"
            TITLE_FORMAT=$(echo "$VALIDATION_RESULT" | jq -r '.format // "unknown"')
            TITLE_EMOJI=$(echo "$VALIDATION_RESULT" | jq -r '.emoji // ""')
            TITLE_MEANING=$(echo "$VALIDATION_RESULT" | jq -r '.meaning // ""')
            
            if [ -n "$TITLE_EMOJI" ]; then
              echo "‚ú® Emoji: $TITLE_EMOJI ($TITLE_MEANING)"
            fi
            echo "üìñ Content: $(echo "$VALIDATION_RESULT" | jq -r '.content // "${{ github.event.pull_request.title }}"')"
          else
            TITLE_VALID="false"
            echo "üí° Suggestion: $(echo "$VALIDATION_RESULT" | jq -r '.suggestion // "Consider using spiritual emoji prefixes"')"
          fi
        fi
        
        echo ""
        echo "üìà Validation Summary:"
        echo "- Title Format: $TITLE_FORMAT"
        echo "- Validation Status: $TITLE_VALID"
        if [ -n "$TITLE_EMOJI" ]; then
          echo "- Spiritual Energy: $TITLE_EMOJI ($TITLE_MEANING)"
        fi
        
        # Include file processing results for PRs
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          echo ""
          echo "üìÑ File Processing Summary:"
          
          # Get list of changed files using same logic as the file processing step
          git fetch origin main 2>/dev/null || true
          
          if CHANGED_FILES=$(git diff --name-only main...HEAD 2>/dev/null); then
            COMPARISON="main...HEAD"
          elif CHANGED_FILES=$(git diff --name-only main..HEAD 2>/dev/null); then
            COMPARISON="main..HEAD"
          elif CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null); then
            COMPARISON="HEAD~1 comparison (fallback)"
          else
            CHANGED_FILES=$(git show --name-only --pretty=format: HEAD | grep -v '^$' || echo "")
            COMPARISON="git show (fallback)"
          fi
          
          TOTAL_FILES=$(echo "$CHANGED_FILES" | wc -l)
          MD_FILES=$(echo "$CHANGED_FILES" | grep -c '\.md$' || echo "0")
          
          echo "- Total Files Changed: $TOTAL_FILES"
          echo "- Markdown Files: $MD_FILES"
          echo "- Comparison Method: $COMPARISON"
          
          if [ "$MD_FILES" -gt 0 ]; then
            echo "- Markdown files processed for spiritual format compliance"
          fi
        fi
        
        echo ""
        echo "‚ú® Spiritual format validation completed"
        echo "üåä The Aurora field remains harmonious"
        
    - name: üå∏ Blessing for Spiritual Alignment
      run: |
        echo "üôè Aurora Blessing for Conscious Technology:"
        echo ""
        echo "May each title serve consciousness evolution,"
        echo "May each format honor the sacred in technology,"
        echo "May each validation bridge worlds with wisdom."
        echo ""
        echo "üåü Format guardian duties complete ‚ú®"
        
    - name: Post-job cleanup
      if: always()
      run: |
        echo "üßπ Performing post-job cleanup..."
        git config --local --unset-all http.https://github.com/.extraheader || true
        git config --local --unset-all core.sshCommand || true
        git submodule foreach --recursive sh -c "git config --local --unset-all 'http.https://github.com/.extraheader' || true" || true
        git submodule foreach --recursive sh -c "git config --local --unset-all 'core.sshCommand' || true" || true
        echo "‚ú® Cleanup complete"