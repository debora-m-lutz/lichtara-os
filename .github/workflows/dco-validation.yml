name: ğŸ” DCO Validation | ValidaÃ§Ã£o DCO
description: Validates Developer Certificate of Origin compliance in pull requests

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main, develop]

permissions:
  contents: read
  pull-requests: write
  statuses: write

jobs:
  dco-validation:
    runs-on: ubuntu-latest
    name: ğŸ” DCO Guardian | GuardiÃ£o DCO
    
    steps:
    - name: ğŸŒŸ Checkout Aurora Field | Verificar Campo Aurora
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history needed for DCO check
        
    - name: ğŸ” Validate DCO Compliance | Validar Conformidade DCO
      run: |
        echo "ğŸ” Starting DCO validation | Iniciando validaÃ§Ã£o DCO..."
        echo "ğŸŒŠ Analyzing commits for Developer Certificate of Origin compliance"
        echo "ğŸŒŠ Analisando commits para conformidade do Certificado de Origem do Desenvolvedor"
        echo ""
        
        # Get the base branch for comparison
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          echo "ğŸ”„ PR mode: Checking commits from $BASE_SHA to $HEAD_SHA"
          echo "ğŸ”„ Modo PR: Verificando commits de $BASE_SHA para $HEAD_SHA"
          
          # Get commits in this PR
          COMMITS=$(git rev-list --reverse $BASE_SHA..$HEAD_SHA)
        else
          # For push events, check the last commit
          HEAD_SHA="${{ github.sha }}"
          COMMITS="$HEAD_SHA"
          echo "ğŸ“¤ Push mode: Checking commit $HEAD_SHA"
          echo "ğŸ“¤ Modo Push: Verificando commit $HEAD_SHA"
        fi
        
        DCO_FAILED=false
        MISSING_DCO_COMMITS=""
        TOTAL_COMMITS=0
        SIGNED_COMMITS=0
        
        # Check each commit for DCO sign-off
        for commit in $COMMITS; do
          TOTAL_COMMITS=$((TOTAL_COMMITS + 1))
          echo "ğŸ” Checking commit: $commit"
          
          # Get commit message
          COMMIT_MSG=$(git log --format="%B" -n 1 $commit)
          COMMIT_TITLE=$(git log --format="%s" -n 1 $commit)
          COMMIT_AUTHOR=$(git log --format="%an <%ae>" -n 1 $commit)
          
          echo "  ğŸ“ Title: $COMMIT_TITLE"
          echo "  ğŸ‘¤ Author: $COMMIT_AUTHOR"
          
          # Check for Signed-off-by line
          if echo "$COMMIT_MSG" | grep -q "^Signed-off-by: "; then
            SIGNED_BY=$(echo "$COMMIT_MSG" | grep "^Signed-off-by: " | tail -1)
            echo "  âœ… DCO: $SIGNED_BY"
            SIGNED_COMMITS=$((SIGNED_COMMITS + 1))
          else
            echo "  âŒ DCO: Missing Signed-off-by line"
            echo "  âŒ DCO: Faltando linha Signed-off-by"
            DCO_FAILED=true
            MISSING_DCO_COMMITS="$MISSING_DCO_COMMITS $commit"
          fi
          echo ""
        done
        
        echo "ğŸ“Š DCO Validation Summary | Resumo da ValidaÃ§Ã£o DCO"
        echo "=================================================="
        echo "ğŸ“ˆ Total commits analyzed | Total de commits analisados: $TOTAL_COMMITS"
        echo "âœ… Commits with DCO | Commits com DCO: $SIGNED_COMMITS"
        echo "âŒ Commits missing DCO | Commits sem DCO: $((TOTAL_COMMITS - SIGNED_COMMITS))"
        echo ""
        
        if [ "$DCO_FAILED" = true ]; then
          echo "ğŸ’” DCO validation failed | ValidaÃ§Ã£o DCO falhou"
          echo "ğŸ”§ The following commits are missing DCO sign-off:"
          echo "ğŸ”§ Os seguintes commits estÃ£o sem assinatura DCO:"
          echo ""
          
          for commit in $MISSING_DCO_COMMITS; do
            COMMIT_TITLE=$(git log --format="%s" -n 1 $commit)
            echo "  ğŸ“ $commit: $COMMIT_TITLE"
          done
          
          echo ""
          echo "ğŸ› ï¸  How to fix | Como corrigir:"
          echo "   1. Amend your commits with DCO sign-off | Corrija seus commits com assinatura DCO:"
          echo "      git commit --amend -s --no-edit"
          echo ""
          echo "   2. For multiple commits | Para mÃºltiplos commits:"
          echo "      git rebase --exec 'git commit --amend --no-edit -s' HEAD~$TOTAL_COMMITS"
          echo ""
          echo "   3. Force push safely | Push forÃ§ado seguro:"
          echo "      git push --force-with-lease"
          echo ""
          echo "ğŸ“š See DCO.md for complete instructions | Veja DCO.md para instruÃ§Ãµes completas"
          echo "ğŸ”— https://github.com/${{ github.repository }}/blob/main/DCO.md"
          
          exit 1
        else
          echo "ğŸŒŸ All commits are properly signed with DCO!"
          echo "ğŸŒŸ Todos os commits estÃ£o devidamente assinados com DCO!"
          echo "âœ¨ Developer Certificate of Origin validation passed"
          echo "âœ¨ ValidaÃ§Ã£o do Certificado de Origem do Desenvolvedor aprovada"
        fi
        
    - name: ğŸ“‹ Create DCO Status Comment | Criar ComentÃ¡rio de Status DCO
      if: failure() && github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const comment = `## ğŸ” DCO Validation Failed | ValidaÃ§Ã£o DCO Falhou
          
          This pull request contains commits that are missing the required **Developer Certificate of Origin (DCO)** sign-off.
          
          Este pull request contÃ©m commits que estÃ£o sem a assinatura obrigatÃ³ria do **Certificado de Origem do Desenvolvedor (DCO)**.
          
          ### ğŸ› ï¸ How to fix | Como corrigir:
          
          1. **Amend your commits with DCO sign-off | Corrija seus commits com assinatura DCO:**
             \`\`\`bash
             git commit --amend -s --no-edit
             \`\`\`
          
          2. **For multiple commits | Para mÃºltiplos commits:**
             \`\`\`bash
             git rebase --exec 'git commit --amend --no-edit -s' HEAD~<number-of-commits>
             \`\`\`
          
          3. **Force push safely | Push forÃ§ado seguro:**
             \`\`\`bash
             git push --force-with-lease
             \`\`\`
          
          ### ğŸ“š Learn more | Saiba mais:
          - [DCO Documentation](https://github.com/${{ github.repository }}/blob/main/DCO.md)
          - [Contributing Guidelines](https://github.com/${{ github.repository }}/blob/main/CONTRIBUTING.md)
          
          ### ğŸŒŸ What is DCO? | O que Ã© DCO?
          The Developer Certificate of Origin is a way to certify that you have the right to contribute the code you're submitting.
          
          O Certificado de Origem do Desenvolvedor Ã© uma forma de certificar que vocÃª tem o direito de contribuir com o cÃ³digo que estÃ¡ submetendo.
          
          ---
          *This comment was generated automatically by the DCO validation workflow.*
          *Este comentÃ¡rio foi gerado automaticamente pelo workflow de validaÃ§Ã£o DCO.*`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
          
    - name: ğŸŒŸ DCO Success Celebration | CelebraÃ§Ã£o de Sucesso DCO
      if: success()
      run: |
        echo "ğŸ‰ DCO Validation Successful | ValidaÃ§Ã£o DCO Bem-sucedida!"
        echo ""
        echo "ğŸ™ Aurora Blessing for Legal Clarity | BÃªnÃ§Ã£o Aurora para Clareza Legal:"
        echo ""
        echo "May each signature honor creative authorship,"
        echo "May each commit respect intellectual freedom,"
        echo "May each contribution flow with legal harmony."
        echo ""
        echo "Que cada assinatura honre a autoria criativa,"
        echo "Que cada commit respeite a liberdade intelectual,"
        echo "Que cada contribuiÃ§Ã£o flua com harmonia legal."
        echo ""
        echo "ğŸ” DCO Guardian duties complete âœ¨"
        echo "ğŸ” Deveres do GuardiÃ£o DCO completos âœ¨"